name: Flutter CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: [ self-hosted, Linux ]

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # ---------------------------------------------------------
    # Java 17 Setup (required for AGP 8.3+)
    # ---------------------------------------------------------
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    # ---------------------------------------------------------
    # Flutter SDK (beta channel)
    # ---------------------------------------------------------
    - name: Setup Flutter (beta)
      uses: subosito/flutter-action@v2
      with:
        channel: 'master'
        architecture: x64

    # ---------------------------------------------------------
    # Ensure SDK directory is writable
    # ---------------------------------------------------------
    - name: Fix Android SDK permissions
      run: |
        sudo chown -R $USER:$USER /opt/android-sdk || true
        sudo chmod -R 755 /opt/android-sdk || true

    # ---------------------------------------------------------
    # Cache: Pub packages
    # ---------------------------------------------------------
    - name: Cache Pub
      uses: actions/cache@v4
      with:
        path: ~/.pub-cache
        key: pub-cache-${{ hashFiles('pubspec.lock') }}

    # ---------------------------------------------------------
    # Cache: Gradle
    # ---------------------------------------------------------
    - name: Cache Gradle
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: gradle-${{ hashFiles('android/gradle/wrapper/gradle-wrapper.properties') }}

    # ---------------------------------------------------------
    # Cache: Android SDK (platforms + build-tools)
    # ---------------------------------------------------------
    - name: Cache Android SDK
      uses: actions/cache@v4
      with:
        path: |
          /opt/android-sdk/platforms
          /opt/android-sdk/build-tools
        key: android-sdk-${{ hashFiles('android/app/build.gradle') }}

    # ---------------------------------------------------------
    # Flutter environment fix for Git
    # ---------------------------------------------------------
    - name: Allow Flutter SDK directory for Git
      run: |
        export HOME=/home/runneruser
        git config --global --add safe.directory "${{ env.FLUTTER_ROOT }}"

    # ---------------------------------------------------------
    # Install dependencies
    # ---------------------------------------------------------
    - name: Get dependencies
      run: flutter pub get

    # ---------------------------------------------------------
    # Formatting
    # ---------------------------------------------------------
    - name: Verify formatting
      run: dart format --set-exit-if-changed .

    # ---------------------------------------------------------
    # Static analysis
    # ---------------------------------------------------------
    - name: Analyze project source
      run: flutter analyze

    # ---------------------------------------------------------
    # Tests
    # ---------------------------------------------------------
    - name: Run tests
      run: flutter test

    # ---------------------------------------------------------
    # Build APK
    # ---------------------------------------------------------
    - name: Build APK (release)
      run: flutter build apk --release

    # ---------------------------------------------------------
    # Build iOS (only on macOS runners)
    # ---------------------------------------------------------
    - name: Build iOS (if applicable)
      if: runner.os == 'macOS'
      run: flutter build ios --release --no-codesign
