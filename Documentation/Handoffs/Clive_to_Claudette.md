# Handoff: Clive → Claudette

**Date:** January 9, 2026  
**From:** Clive (Review Specialist)  
**To:** Claudette (Security & Service Implementation)  
**Status:** Approved for Crypto Upgrade  
**Phase:** 26 — Encrypted Backup (Crypto Implementation)

---

## Task Overview

I have reviewed the `BackupService` foundation. The architecture is sound, and the rollback safety is excellent. I have added `pointycastle` to `pubspec.yaml` and run `flutter pub get`. 

Your next task is to replace the XOR placeholder with production-grade encryption and fix the remaining test failures.

## Objectives

### 1. Cryptography Upgrade
- **Implement AES-256-GCM:** Replace `_xorCipher` and `_computeAuthTag` in `lib/services/backup_service.dart` with `pointycastle`'s `GCMBlockCipher(AESEngine())`.
- **Authenticated Encryption:** Ensure the `authTag` generated by GCM is stored in the header and verified during decryption.
- **Header updates:** Ensure the `iv` and `authTag` are correctly handled during the binary parsing/serialization.

### 2. Test Suite Stability
- **Filename Collisions:** In `lib/services/backup_service.dart`, update the timestamp format in `createBackup` to include seconds (`yyyyMMdd_HHmmss`) to prevent test failures when multiple backups are created rapidly.
- **Secure Storage Mocking:** In `test/services/backup_service_test.dart`, mock the `FlutterSecureStorage` platform channel calls to allow the `restoreBackup` test to pass (it currently fails on `SecurePasswordManager` initialization).
- **85% Coverage:** Aim for ≥85% test coverage for the `BackupService`.

## Technical Notes

### PointyCastle AES-GCM Example
```dart
import 'package:pointycastle/export.dart';

// Encryption
final cipher = GCMBlockCipher(AESEngine())
  ..init(true, AEADParameters(KeyParameter(key), 128, iv, Uint8List(0)));
final encrypted = cipher.process(plaintext);
final tag = cipher.mac;

// Decryption
final cipher = GCMBlockCipher(AESEngine())
  ..init(false, AEADParameters(KeyParameter(key), 128, iv, Uint8List(0)));
// Note: cipher.process requires the tag to be appended to the encrypted data
// or handled according to pointycastle's GCM implementation details.
```

## Relevant Files

- [lib/services/backup_service.dart](lib/services/backup_service.dart)
- [test/services/backup_service_test.dart](test/services/backup_service_test.dart)
- [pubspec.yaml](pubspec.yaml) (Already updated with `pointycastle`)

## Success Criteria

1.  **AES-256-GCM** replaces XOR cipher.
2.  **All 10 tests pass** in `test/services/backup_service_test.dart`.
3.  **Test coverage** ≥ 85% for `BackupService`.
4.  **No `any` or `dynamic` types** used unless strictly necessary (Coding Standards compliance).
